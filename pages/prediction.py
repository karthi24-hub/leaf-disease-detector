import streamlit as st
from PIL import Image
import os
from predict import predict_disease
from disease_info import disease_info

# Page config
st.set_page_config(
    page_title="Analysis | AgriGuard AI",
    page_icon="üî¨",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Load external CSS
with open("assets/style.css") as f:
    st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

# Navigation
if st.button("‚Üê Back to Dashboard", type="secondary"):
    st.switch_page("app.py")

# Header
st.markdown("""
<div class="page-header">
    <h1>üî¨ Neural Diagnostic Suite</h1>
    <p>Upload high-resolution leaf imagery for real-time pathological quantification</p>
</div>
""", unsafe_allow_html=True)

# Layout
col1, col2 = st.columns([1, 1], gap="large")

with col1:
    st.markdown("### üì§ Image Acquisition")
    uploaded_file = st.file_uploader(
        "Drop specimen image here",
        type=["jpg", "jpeg", "png"],
        help="Upload a clear image of the affected plant leaf"
    )

    if uploaded_file is not None:
        img = Image.open(uploaded_file)
        st.image(img, caption="üî¨ Current Specimen", use_container_width=True)
        
        # Save temp file
        with open("temp.jpg", "wb") as f:
            f.write(uploaded_file.getbuffer())

with col2:
    if uploaded_file is not None:
        st.markdown("### üìä System Analysis")
        
        if st.button("üöÄ Execute Analysis", type="primary", use_container_width=True):
            with st.spinner("üß¨ Sequencing pathological patterns..."):
                label, confidence = predict_disease("temp.jpg")
                confidence = confidence * 100 # Convert to percentage
            
            # Prediction Label cleaning
            clean_label = label.replace('_', ' ').title()
            
            # Result Card
            st.markdown(f"""
            <div class="result-card">
                <div class="result-header">
                    <p style="text-transform: uppercase; letter-spacing: 2px; color: #666; font-size: 0.8rem; margin-bottom: 0.5rem;">Diagnostic Result</p>
                    <h3>{clean_label}</h3>
                    <div class="confidence-meter">
                        <div class="confidence-fill" style="width: {confidence}%;"></div>
                    </div>
                    <p style="margin-top: 10px; font-weight: 600; color: #2D5A27;">Confidence Score: {confidence:.1f}%</p>
                </div>
            </div>
            """, unsafe_allow_html=True)

            # Details Tabs
            tab1, tab2, tab3 = st.tabs(["üíä Treatment Protocol", "üå± Nutrient Strategy", "‚ÑπÔ∏è Specimen Info"])
            
            with tab1:
                if label in disease_info:
                    cure = disease_info[label]["cure"]
                    st.markdown(f"""
                    <div class="info-box">
                        <h4>Recommended Protocol</h4>
                        <p>{cure}</p>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    st.warning("Pathological treatment data not found for this specific strain.")

            with tab2:
                if label in disease_info:
                    supplements = disease_info[label]["supplements"]
                    st.markdown(f"""
                    <div class="info-box">
                        <h4>Nutrient Optimization</h4>
                        <p>{supplements}</p>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    st.warning("Supplementation data currently unavailable.")
            
            with tab3:
                st.markdown(f"""
                <div class="info-box">
                    <h4>Analysis Metadata</h4>
                    <p><strong>Detected Category:</strong> {clean_label}</p>
                    <p><strong>System ID:</strong> AG-RES-2026</p>
                    <p><strong>Status:</strong> Completed</p>
                    <br>
                    <p style="font-size: 0.8rem; color: #888;">* This report is generated by AgriGuard AI. Please verify with a licensed agronomist for critical decisions.</p>
                </div>
                """, unsafe_allow_html=True)
    else:
        # Placeholder state
        st.markdown("""
        <div style="text-align: center; padding: 4rem 2rem; background: #f0f2f0; border-radius: 24px; border: 2px dashed #ccc;">
            <p style="color: #888; font-size: 1.1rem;">Waiting for specimen upload...</p>
        </div>
        """, unsafe_allow_html=True)

# Footer
st.markdown("""
<div class="footer">
    <p>¬© 2026 AgriGuard | AI-Powered Plant Pathology</p>
</div>
""", unsafe_allow_html=True)